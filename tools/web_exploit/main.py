import requests
from datetime import datetime
import os


class Tool:
    def __init__(self):
        self.name = "web_exploit"
        self.description = "DVWA Web Exploitation Tool"
        self.target = "http://192.168.107.129"
        self.user = "admin"
        self.password = "password"
        self.session = None
        self.logged_in = False
        self.sub_modules = {}
        self.current_sub = None

    def load_sub_modules(self):
        sub_dir = os.path.join("tools", "web_exploit", "modules")

        if not os.path.isdir(sub_dir):
            print("[-] modules/ folder not found inside web_exploit")
            return

        for filename in os.listdir(sub_dir):
            if filename.endswith(".py") and not filename.startswith("__"):
                module_name = filename[:-3]
                try:
                    module = __import__(f"tools.web_exploit.modules.{module_name}", fromlist=[""])
                    if hasattr(module, "Module"):
                        sub_instance = module.Module()
                        sub_instance.session = self.session  # Share authenticated session
                        sub_instance.logged_in = self.logged_in
                        sub_instance.target = self.target
                        self.sub_modules[module_name] = sub_instance
                        print(f"[+] Loaded sub-module: {module_name}")
                    else:
                        print(f"[-] {filename} has no 'Module' class")
                except Exception as e:
                    print(f"[-] Failed to load {module_name}: {e}")

    def show_options(self):
        print("\n=== Web Exploit Tool ===")
        print(f" target → {self.target}")
        print(f" user → {self.user}")
        print(f" password → {self.password}\n")

        print("Available sub-modules:")
        for m in self.sub_modules.keys():
            print(f" - {m}")

        print("\nCommands:")
        print(" use <submodule> - e.g. use cmd_injection")
        print(" setup - Login & set DVWA security low, then load sub-modules")
        print(" set target <url>")
        print(" show options")
        print(" back / exit")

    def handle_command(self, cmd_input):
        cmd = cmd_input.strip()
        low = cmd.lower()

        # If we're in a sub-module, delegate to it
        if self.current_sub:
            self.current_sub.handle_command(cmd_input)
            if low in ["back", "exit", "quit"]:
                self.current_sub = None
                print("[*] Returned to web_exploit menu")
            return

        if low == "show options":
            self.show_options()
            return

        if low.startswith("set target"):
            parts = cmd.split(maxsplit=2)
            if len(parts) < 3:
                print("Usage: set target <url>")
                return

            value = parts[2].strip()
            if not value.startswith(("http://", "https://")):
                value = "http://" + value

            self.target = value.rstrip("/")

            # Sync to sub-modules if loaded
            for sub in self.sub_modules.values():
                sub.target = self.target

            print(f"[+] target → {self.target}")
            return

        if low in ["setup", "login"]:
            self._login_and_setup()
            return

        if low.startswith("use "):
            parts = low.split()
            if len(parts) < 2:
                print("Usage: use <submodule>")
                return

            sub_name = parts[1]
            if sub_name in self.sub_modules:
                self.current_sub = self.sub_modules[sub_name]
                print(f"[+] Entered sub-module: {sub_name}")
                self.current_sub.show_options()
            else:
                print(f"[-] Sub-module '{sub_name}' not found")
            return

        if low in ["back", "exit", "quit"]:
            print("[*] Returning to main Bandito menu...")
            return

        print("Unknown command. Try 'show options'")

    def _login_and_setup(self):
        if self.logged_in:
            print("[+] Already logged in")
            return

        print(f"[*] Logging into {self.target}...")

        self.session = requests.Session()
        login_url = f"{self.target}/login.php"
        r_get = self.session.get(login_url)

        token_marker = "name='user_token' value='"
        token_pos = r_get.text.find(token_marker)
        user_token = ""

        if token_pos != -1:
            start = token_pos + len(token_marker)
            end = r_get.text.find("'", start)
            user_token = r_get.text[start:end]

        login_data = {
            "username": self.user,
            "password": self.password,
            "user_token": user_token,
            "Login": "Login",
        }

        r_login = self.session.post(login_url, data=login_data, allow_redirects=True)

        if "Logout" in r_login.text:
            print("[+] Login successful")
        else:
            print("[-] Login failed")
            return

        sec_url = f"{self.target}/security.php"
        self.session.post(sec_url, data={"security": "low", "seclev_submit": "Submit"})

        self.logged_in = True
        self.load_sub_modules()

        print("[+] Web Exploit ready. Use 'use cmd_injection', 'use file_upload', etc.")
